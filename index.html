<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MS VITA_SYNC - Dashboard (ERA)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#16a34a;
      --accent-2:#0ea5e9;
      --danger:#ef4444;
      font-family: 'Poppins', system-ui, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: linear-gradient(180deg,#fbfdff 0%, var(--bg) 100%);
      color:#0f172a;
      min-height:100vh;
      display:flex;align-items:center;justify-content:center;padding:28px;
    }
    .app{width:100%;max-width:1200px}

    /* Auth card */
    .auth-wrap{display:flex;gap:24px;align-items:flex-start}
    .auth-card{
      width:420px;
      background:var(--card);border-radius:16px;padding:20px;box-shadow:0 12px 40px rgba(10,20,40,.06);
    }
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:6px}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;color:white;font-weight:800}
    .tabs{display:flex;gap:8px;margin:12px 0}
    .tab{flex:1;padding:10px;border-radius:10px;text-align:center;background:#f1f5f9;cursor:pointer;font-weight:600}
    .tab.active{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:white}

    .auth-form{display:none;flex-direction:column;gap:8px}
    .auth-form.active{display:flex}
    input,textarea,select{padding:10px;border-radius:10px;border:1px solid #eef2f6;background:#fbfdff;font-size:14px}
    .row{display:flex;gap:8px}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:white;font-weight:700}
    .btn-ghost{background:transparent;border:1px solid #edf2f7;color:var(--muted)}

    /* Dashboard */
    .dashboard{display:none;margin-top:8px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .device-info{background:var(--card);border-radius:12px;padding:10px 14px;box-shadow:0 6px 18px rgba(20,40,60,.04);display:flex;align-items:center;gap:12px}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(10,20,40,.04);cursor:pointer;transition:transform .12s}
    .card:hover{transform:translateY(-6px)}
    .value{font-size:28px;font-weight:700}
    .sub{font-size:12px;color:var(--muted)}

    .main{display:flex;gap:18px;align-items:flex-start;margin-top:12px}
    .left{flex:1}
    .right{width:360px}

    table{width:100%;border-collapse:collapse}
    thead th{ text-align:left;color:var(--muted);font-weight:600;padding:10px 8px;border-bottom:1px solid #edf1f4}
    tbody td{padding:8px 8px;border-bottom:1px solid #f1f5f8}
    .status-normal{color:green;font-weight:600}
    .status-warn{color:orange;font-weight:600}
    .status-danger{color:var(--danger);font-weight:700}

    .modal-backdrop{position:fixed;inset:0;background:rgba(12,20,30,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{background:var(--card);border-radius:12px;padding:16px;width:92%;max-width:920px;box-shadow:0 30px 60px rgba(10,20,40,.4)}

    .profile-btn{padding:8px 10px;border-radius:10px;border:1px solid #eef2f6;background:white;cursor:pointer}

    /* responsive */
    @media (max-width:980px){
      .auth-wrap{flex-direction:column;align-items:center}
      .right{width:100%}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- AUTH + DASHBOARD in one file -->
    <div id="authSection" class="auth-wrap">
      <!-- left: auth -->
      <div class="auth-card">
        <div class="brand">
          <div class="logo">MV</div>
          <div>
            <div style="font-weight:700">MS VITA_SYNC</div>
            <div style="font-size:13px;color:var(--muted)">S·ª©c kh·ªèe th√¥ng minh</div>
          </div>
        </div>

        <div class="tabs">
          <div id="tabLogin" class="tab active">ƒêƒÉng nh·∫≠p</div>
          <div id="tabRegister" class="tab">ƒêƒÉng k√Ω</div>
        </div>

        <!-- login -->
        <form id="loginForm" class="auth-form active">
          <input id="loginUser" placeholder="T√™n ƒëƒÉng nh·∫≠p" autocomplete="username">
          <div style="position:relative">
            <input id="loginPass" type="password" placeholder="M·∫≠t kh·∫©u" autocomplete="current-password">
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button id="btnGuest" type="button" class="btn btn-ghost">Xem th·ª≠</button>
            <button id="loginBtn" type="submit" class="btn btn-primary">ƒêƒÉng nh·∫≠p</button>
          </div>
          <div id="loginMessage" style="margin-top:8px"></div>
        </form>

        <!-- register -->
        <form id="registerForm" class="auth-form" style="margin-top:6px">
          <input id="regUser" placeholder="T√™n ƒëƒÉng nh·∫≠p">
          <input id="regPass" type="password" placeholder="M·∫≠t kh·∫©u">
          <input id="regName" placeholder="H·ªç v√† t√™n">
          <div class="row">
            <input id="regAge" type="number" placeholder="Tu·ªïi">
            <input id="regGender" placeholder="Gi·ªõi t√≠nh">
          </div>
          <div class="row">
            <input id="regHeight" type="number" placeholder="Chi·ªÅu cao (cm)">
            <input id="regWeight" type="number" placeholder="C√¢n n·∫∑ng (kg)">
          </div>
          <textarea id="regHistory" rows="2" placeholder="Ti·ªÅn s·ª≠ b·ªánh l√Ω"></textarea>
          <div style="display:flex;justify-content:flex-end;gap:8px">
            <button id="registerBtn" type="button" class="btn btn-primary">T·∫°o t√†i kho·∫£n</button>
          </div>
          <div id="registerMessage" style="margin-top:8px"></div>
        </form>
      </div>

      <!-- right: preview -->
      <div style="flex:1;min-width:320px">
        <div style="background:var(--card);padding:18px;border-radius:12px;box-shadow:0 12px 30px rgba(10,20,40,.04)">
          <div style="font-weight:700;margin-bottom:6px">Demo / H∆∞·ªõng d·∫´n</div>
          <div style="color:var(--muted);font-size:13px">- D√πng \"Xem th·ª≠\" ƒë·ªÉ t·∫°o t√†i kho·∫£n demo.<br>- ƒêƒÉng k√Ω ƒë·ªÉ l∆∞u h·ªì s∆° v√†o localStorage.<br>- Sau khi ƒëƒÉng nh·∫≠p, dashboard s·∫Ω hi·ªÉn th·ªã v√† b·∫Øt ƒë·∫ßu l·∫•y d·ªØ li·ªáu t·ª´ Era n·∫øu c·∫•u h√¨nh.</div>
          <hr style="margin:12px 0;border:none;border-top:1px solid #f1f5f8">
          <div style="font-weight:700">K·∫øt n·ªëi Era</div>
          <div style="color:var(--muted);font-size:13px">B·∫°n c·∫ßn cung c·∫•p token & deviceId b√™n trong m√£ (connectEra) ƒë·ªÉ nh·∫≠n d·ªØ li·ªáu th·∫≠t.</div>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
      <div class="topbar">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="logo" style="width:44px;height:44px;font-size:14px">MV</div>
          <div>
            <div style="font-weight:800">MS VITA_SYNC</div>
            <div id="topSub" style="color:var(--muted);font-size:13px">S·ª©c kh·ªèe th√¥ng minh</div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px">
          <div style="text-align:right">
            <div id="userGreet" style="font-weight:700">Xin ch√†o</div>
            <div id="userMeta" style="font-size:12px;color:var(--muted)"></div>
          </div>
          <button id="profileBtn" class="profile-btn">H·ªì s∆°</button>
          <div class="device-info">
            <div style="min-width:52px">
              <small>Thi·∫øt b·ªã</small>
              <b id="deviceId">‚Äî</b>
            </div>
            <div style="min-width:56px;text-align:right">
              <small>Firmware</small>
              <div style="font-weight:700">‚Äî</div>
            </div>
          </div>
          <button id="logoutBtn" class="btn btn-ghost">ƒêƒÉng xu·∫•t</button>
        </div>
      </div>

      <div class="grid">
        <div class="card" data-type="hr">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div style="font-size:16px">‚ù§Ô∏è Nh·ªãp tim</div><div class="sub">BPM</div></div>
            <div class="value" id="hr">--</div>
          </div>
          <div style="text-align:right;color:var(--muted);font-size:12px">C·∫≠p nh·∫≠t: <span id="hrTime">--</span></div>
        </div>

        <div class="card" data-type="spo2">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div style="font-size:16px">üí® SpO‚ÇÇ</div><div class="sub">%</div></div>
            <div class="value" id="spo2">--</div>
          </div>
          <div style="text-align:right;color:var(--muted);font-size:12px">C·∫≠p nh·∫≠t: <span id="spo2Time">--</span></div>
        </div>

        <div class="card" data-type="bp">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div style="font-size:16px">ü©∏ Huy·∫øt √°p</div><div class="sub">mmHg</div></div>
            <div class="value" id="bp">--</div>
          </div>
          <div style="text-align:right;color:var(--muted);font-size:12px">C·∫≠p nh·∫≠t: <span id="bpTime">--</span></div>
        </div>

        <div class="card" data-type="temp">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div style="font-size:16px">üå°Ô∏è Nhi·ªát ƒë·ªô</div><div class="sub">¬∞C</div></div>
            <div class="value" id="temp">--</div>
          </div>
          <div style="text-align:right;color:var(--muted);font-size:12px">C·∫≠p nh·∫≠t: <span id="tempTime">--</span></div>
        </div>
      </div>

      <div class="main">
        <div class="left">
          <div style="background:var(--card);padding:14px;border-radius:12px;box-shadow:0 10px 30px rgba(10,20,40,.04)">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:700">T·ªïng quan s·ª©c kh·ªèe</div>
              <div style="color:var(--muted);font-size:13px">D·ªØ li·ªáu th·ªùi gian th·ª±c</div>
            </div>
            <div id="overviewText" style="color:var(--muted)">Nh·∫•n m·ªôt √¥ tr√™n ƒë·ªÉ xem chi ti·∫øt.</div>
          </div>
        </div>

        <div class="right">
          <div style="background:var(--card);padding:12px;border-radius:12px;box-shadow:0 10px 30px rgba(10,20,40,.04)">
            <div style="font-weight:700;margin-bottom:8px">L·∫ßn ƒëo g·∫ßn ƒë√¢y</div>
            <table><thead><tr><th>Th·ªùi gian</th><th>Ch·ªâ s·ªë</th><th>Gi√° tr·ªã</th></tr></thead><tbody id="recentList"></tbody></table>
          </div>
        </div>
      </div>
    </div>

    <!-- modal chart -->
    <div id="modalBackdrop" class="modal-backdrop">
      <div class="modal">
        <div style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div>
              <div id="modalTitle" style="font-weight:800"></div>
              <div id="modalSubtitle" style="color:var(--muted);font-size:13px">Bi·ªÉu ƒë·ªì theo gi·ªù</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <div id="rangeInfo" style="font-size:13px;color:var(--muted)"></div>
              <div class="close-btn" id="closeModal">‚úñ</div>
            </div>
          </div>
          <div style="height:280px"><canvas id="lineChart"></canvas></div>
        </div>
        <div style="width:320px;padding-left:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">B·∫£ng s·ªë li·ªáu</div>
            <button id="exportBtn" class="btn">T·∫£i CSV</button>
          </div>
          <div style="height:260px;overflow:auto">
            <table><thead><tr><th>Th·ªùi gian</th><th>Gi√° tr·ªã</th><th>Tr·∫°ng th√°i</th></tr></thead><tbody id="modalTable"></tbody></table>
          </div>
        </div>
      </div>
    </div>

    <!-- profile modal -->
    <div id="profileBackdrop" class="modal-backdrop">
      <div class="modal" style="max-width:520px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div><div style="font-weight:800">H·ªì s∆° ng∆∞·ªùi d√πng</div><div style="color:var(--muted);font-size:13px">Xem / ch·ªânh th√¥ng tin</div></div>
          <div class="close-btn" id="closeProfile">‚úñ</div>
        </div>
        <form id="profileForm" style="display:flex;flex-direction:column;gap:8px">
          <input id="pfName" placeholder="H·ªç v√† t√™n">
          <div class="row">
            <input id="pfAge" type="number" placeholder="Tu·ªïi">
            <input id="pfGender" placeholder="Gi·ªõi t√≠nh">
          </div>
          <div class="row">
            <input id="pfHeight" type="number" placeholder="Chi·ªÅu cao (cm)">
            <input id="pfWeight" type="number" placeholder="C√¢n n·∫∑ng (kg)">
          </div>
          <textarea id="pfHistory" rows="2" placeholder="Ti·ªÅn s·ª≠ b·ªánh l√Ω"></textarea>
          <div style="display:flex;justify-content:flex-end;gap:8px">
            <button type="button" id="pfCancel" class="btn btn-ghost">Hu·ª∑</button>
            <button type="submit" class="btn btn-primary">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>

  </div>

<script>
/*
  All-in-one:
  - Auth (register/login) saved to localStorage (mv_users, mv_current_user)
  - Dashboard (shows hr, spo2, bp, temp)
  - connectEra(): if EraWidget exists, uses it; otherwise fallback to simulated realtime
  - Chart modal, CSV export
*/

/* ---------- storage helpers ---------- */
function loadUsers(){ try{ return JSON.parse(localStorage.getItem('mv_users')||'{}'); }catch(e){return{};} }
function saveUsers(u){ localStorage.setItem('mv_users', JSON.stringify(u)); }
function setCurrentUser(u){ if(u) localStorage.setItem('mv_current_user', u); else localStorage.removeItem('mv_current_user'); }
function getCurrentUser(){ return localStorage.getItem('mv_current_user') || null; }

/* ---------- DOM refs ---------- */
const tabLogin = document.getElementById('tabLogin');
const tabRegister = document.getElementById('tabRegister');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const btnGuest = document.getElementById('btnGuest');
const loginMessage = document.getElementById('loginMessage');
const registerMessage = document.getElementById('registerMessage');

const authSection = document.getElementById('authSection');
const dashboard = document.getElementById('dashboard');
const userGreet = document.getElementById('userGreet');
const userMeta = document.getElementById('userMeta');
const deviceIdEl = document.getElementById('deviceId');

const profileBtn = document.getElementById('profileBtn');
const profileBackdrop = document.getElementById('profileBackdrop');
const closeProfile = document.getElementById('closeProfile');
const profileForm = document.getElementById('profileForm');
const pfCancel = document.getElementById('pfCancel');

const logoutBtn = document.getElementById('logoutBtn');

const modalBackdrop = document.getElementById('modalBackdrop');
const closeModal = document.getElementById('closeModal');
const exportBtn = document.getElementById('exportBtn');

const modalTitle = document.getElementById('modalTitle');
const modalTable = document.getElementById('modalTable');
const rangeInfo = document.getElementById('rangeInfo');

const hrEl = document.getElementById('hr');
const spo2El = document.getElementById('spo2');
const bpEl = document.getElementById('bp');
const tempEl = document.getElementById('temp');
const hrTimeEl = document.getElementById('hrTime');
const spo2TimeEl = document.getElementById('spo2Time');
const bpTimeEl = document.getElementById('bpTime');
const tempTimeEl = document.getElementById('tempTime');

const recentList = document.getElementById('recentList');

let currentChart = null;

/* ---------- tab toggles ---------- */
tabLogin.addEventListener('click', ()=>{ tabLogin.classList.add('active'); tabRegister.classList.remove('active'); loginForm.classList.add('active'); registerForm.classList.remove('active'); });
tabRegister.addEventListener('click', ()=>{ tabRegister.classList.add('active'); tabLogin.classList.remove('active'); registerForm.classList.add('active'); loginForm.classList.remove('active'); });

/* ---------- Auth logic ---------- */
btnGuest.addEventListener('click', ()=>{
  const users = loadUsers();
  if(!users['demo']){
    users['demo'] = { password:'demo', profile:{ name:'Ng∆∞·ªùi d√πng Demo', age:30, gender:'Kh√°c', height:170, weight:70, history:'' }, settings:{ thrSpo2:94, thrHrHigh:100 } };
    saveUsers(users);
  }
  setCurrentUser('demo');
  enterDashboard();
});

registerBtn.addEventListener('click', ()=>{
  const u = document.getElementById('regUser').value.trim();
  const p = document.getElementById('regPass').value;
  if(!u || !p){ registerMessage.innerHTML = '<div style="color:#dc2626">Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p & m·∫≠t kh·∫©u</div>'; return; }
  const users = loadUsers();
  if(users[u]){ registerMessage.innerHTML = '<div style="color:#dc2626">T√†i kho·∫£n ƒë√£ t·ªìn t·∫°i</div>'; return; }
  users[u] = { password:p, profile:{
    name: document.getElementById('regName').value || u,
    age: document.getElementById('regAge').value || '',
    gender: document.getElementById('regGender').value || '',
    height: document.getElementById('regHeight').value || '',
    weight: document.getElementById('regWeight').value || '',
    history: document.getElementById('regHistory').value || ''
  }, settings:{ thrSpo2:94, thrHrHigh:100 } };
  saveUsers(users);
  setCurrentUser(u);
  registerMessage.innerHTML = '<div style="color:green">T·∫°o t√†i kho·∫£n th√†nh c√¥ng. ƒêang v√†o dashboard...</div>';
  setTimeout(()=> enterDashboard(), 600);
});

loginForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  const users = loadUsers();
  if(!users[u]){ loginMessage.innerHTML = '<div style="color:#dc2626">T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i</div>'; return; }
  if(users[u].password !== p){ loginMessage.innerHTML = '<div style="color:#dc2626">Sai m·∫≠t kh·∫©u</div>'; return; }
  setCurrentUser(u);
  loginMessage.innerHTML = '<div style="color:green">ƒêƒÉng nh·∫≠p th√†nh c√¥ng. ƒêang v√†o dashboard...</div>';
  setTimeout(()=> enterDashboard(), 500);
});

/* ---------- Profile & logout ---------- */
profileBtn.addEventListener('click', openProfile);
closeProfile.addEventListener('click', ()=> profileBackdrop.style.display='none');
pfCancel.addEventListener('click', ()=> profileBackdrop.style.display='none');

profileForm.addEventListener('submit', (e)=>{
  e.preventDefault(); saveProfileFromForm(); profileBackdrop.style.display='none';
});

logoutBtn.addEventListener('click', ()=>{
  if(confirm('ƒêƒÉng xu·∫•t?')){ setCurrentUser(null); showAuth(); }
});

/* ---------- show/hide auth & dashboard ---------- */
function showAuth(){ dashboard.style.display='none'; authSection.style.display='flex'; }
function showDashboard(){ authSection.style.display='none'; dashboard.style.display='block'; }

/* ---------- apply user to UI ---------- */
function applyUserToUI(){
  const cur = getCurrentUser();
  if(!cur) return;
  const users = loadUsers();
  const me = users[cur] || {};
  const p = me.profile || {};
  userGreet.innerText = `Xin ch√†o, ${p.name || cur}`;
  userMeta.innerText = p.age ? `${p.age} tu·ªïi ‚Ä¢ ${p.gender||''}` : '';
  deviceIdEl.innerText = (me.deviceId) ? me.deviceId : 'R12M-LOCAL';
  // apply thresholds if exist
  if(me.settings){ thresholds.spo2_warn = me.settings.thrSpo2 || thresholds.spo2_warn; thresholds.hr_high = me.settings.thrHrHigh || thresholds.hr_high; }
}

/* ---------- profile save ---------- */
function openProfile(){
  const cur = getCurrentUser();
  if(!cur){ alert('Ch∆∞a ƒëƒÉng nh·∫≠p'); return; }
  const users = loadUsers();
  const me = users[cur] || { profile:{} };
  const p = me.profile || {};
  document.getElementById('pfName').value = p.name || '';
  document.getElementById('pfAge').value = p.age || '';
  document.getElementById('pfGender').value = p.gender || '';
  document.getElementById('pfHeight').value = p.height || '';
  document.getElementById('pfWeight').value = p.weight || '';
  document.getElementById('pfHistory').value = p.history || '';
  profileBackdrop.style.display = 'flex';
}

function saveProfileFromForm(){
  const cur = getCurrentUser();
  if(!cur) return;
  const users = loadUsers();
  users[cur] = users[cur] || {};
  users[cur].profile = users[cur].profile || {};
  users[cur].profile.name = document.getElementById('pfName').value;
  users[cur].profile.age = document.getElementById('pfAge').value;
  users[cur].profile.gender = document.getElementById('pfGender').value;
  users[cur].profile.height = document.getElementById('pfHeight').value;
  users[cur].profile.weight = document.getElementById('pfWeight').value;
  users[cur].profile.history = document.getElementById('pfHistory').value;
  saveUsers(users);
  applyUserToUI();
  alert('ƒê√£ l∆∞u h·ªì s∆°');
}

/* ---------- simulated hourly data generator (fallback) ---------- */
function makeHourlySeries(base,variation,min,max,round=0){
  const arr=[];
  for(let h=0;h<24;h++){
    const trend = Math.sin((h/24)*Math.PI*2)*variation*0.4;
    const noise = (Math.random()*2-1)*variation;
    let v = base + trend + noise;
    v = Math.max(min, Math.min(max, v));
    if(round) v = Math.round(v);
    else v = Math.round(v*10)/10;
    arr.push({time: `${String(h).padStart(2,'0')}:00`, value: v});
  }
  return arr;
}

const hourlyData = {
  hr: [60],
  spo2: makeHourlySeries(97,3,85,100,0),
  bp: [],
  temp: makeHourlySeries(36.6,0.7,35.5,38.5,1)
};
for(let i=0;i<24;i++){
  const sys = Math.round(115 + Math.sin(i/24*Math.PI*2)*8 + (Math.random()*10-5));
  const dia = Math.round(75 + Math.cos(i/24*Math.PI*2)*6 + (Math.random()*6-3));
  hourlyData.bp.push({time: `${String(i).padStart(2,'0')}:00`, value: `${sys}/${dia}`, sys, dia});
}

/* ---------- thresholds ---------- */
const thresholds = { spo2_warn:94, hr_high:100 };

/* ---------- overview population ---------- */
function setOverviewValues(){
  const lastHr = hourlyData.hr[23].value;
  const lastSpo2 = hourlyData.spo2[23].value;
  const lastBp = hourlyData.bp[23].value;
  const lastTemp = hourlyData.temp[23].value;
  hrEl.innerText = `${lastHr}`;
  spo2El.innerText = `${lastSpo2}%`;
  bpEl.innerText = `${lastBp}`;
  tempEl.innerText = `${lastTemp}¬∞C`;
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0') + ':00';
  hrTimeEl.innerText = hh; spo2TimeEl.innerText = hh; bpTimeEl.innerText = hh; tempTimeEl.innerText = hh;

  // recent list
  recentList.innerHTML = '';
  for(let i=23;i>=19;i--){
    const t = hourlyData.hr[i].time;
    const r1 = `<tr><td>${t}</td><td>Nh·ªãp tim</td><td>${hourlyData.hr[i].value}</td></tr>`;
    const r2 = `<tr><td>${t}</td><td>SpO‚ÇÇ</td><td>${hourlyData.spo2[i].value}%</td></tr>`;
    recentList.insertAdjacentHTML('beforeend', r1);
    recentList.insertAdjacentHTML('beforeend', r2);
  }
}

/* ---------- modal chart logic ---------- */
function statusFor(type, valueObj){
  if(type==='spo2'){
    const v = Number(valueObj.value);
    if(v >= thresholds.spo2_warn) return ['B√¨nh th∆∞·ªùng','status-normal'];
    if(v >= thresholds.spo2_warn-4) return ['C·∫£nh b√°o','status-warn'];
    return ['Nguy hi·ªÉm','status-danger'];
  } else if(type==='hr'){
    const v = Number(valueObj.value);
    if(v >= thresholds.hr_high+20) return ['Nguy hi·ªÉm','status-danger'];
    if(v > thresholds.hr_high) return ['C·∫£nh b√°o','status-warn'];
    return ['B√¨nh th∆∞·ªùng','status-normal'];
  } else if(type==='bp'){
    const sys = valueObj.sys;
    if(sys >= 160) return ['Nguy hi·ªÉm','status-danger'];
    if(sys >= 140) return ['C·∫£nh b√°o','status-warn'];
    return ['B√¨nh th∆∞·ªùng','status-normal'];
  } else if(type==='temp'){
    const v = Number(valueObj.value);
    if(v >= 38) return ['S·ªët','status-warn'];
    return ['B√¨nh th∆∞·ªùng','status-normal'];
  }
  return ['N/A',''];
}

let currentChartObj = null;
let currentModalType = null;

function openModal(type){
  currentModalType = type;
  modalBackdrop.style.display = 'flex';
  modalTitle.innerText = (type==='hr'? 'Nh·ªãp tim (BPM)': type==='spo2'? 'SpO‚ÇÇ (%)' : type==='bp'? 'Huy·∫øt √°p (mmHg)': 'Nhi·ªát ƒë·ªô (¬∞C)');
  rangeInfo.innerText = `Ng∆∞·ª°ng: ${type==='hr'? thresholds.hr_high : (type==='spo2'? thresholds.spo2_warn : '‚Äî')}`;

  let labels = [], data = [];
  if(type==='hr'){ labels = eradata.hr.map(d=>d.time); data = eradata.hr.map(d=>d.value); }
  if(type==='spo2'){ labels = eradata.spo2.map(d=>d.time); data = eradata.spo2.map(d=>d.value); }
  if(type==='bp'){ labels = eradata.bp.map(d=>d.time); data = eradata.bp.map(d=>d.sys); }
  if(type==='temp'){ labels = eradata.temp.map(d=>d.time); data = eradata.temp.map(d=>d.value); }

  // Chart
  if(currentChartObj){ currentChartObj.destroy(); currentChartObj = null; }
  const ctx = document.getElementById('lineChart').getContext('2d');
  currentChartObj = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets:[{ label: modalTitle.innerText, data, tension:0.3, fill:true, pointRadius:3 }] },
    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ grid:{color:'#eef2f6'} }, x:{ grid:{display:false} } }, plugins:{ legend:{display:false} } },
    plugins: [{
      id: 'thresholdLine',
      afterDraw(chart){
        const warn = (type==='hr'? thresholds.hr_high : (type==='spo2'? thresholds.spo2_warn : null));
        if(warn===null || warn===undefined) return;
        const yScale = chart.scales.y;
        const yPixel = yScale.getPixelForValue(warn);
        const ctx = chart.ctx;
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(chart.chartArea.left, yPixel);
        ctx.lineTo(chart.chartArea.right, yPixel);
        ctx.strokeStyle = 'rgba(255,165,0,0.9)';
        ctx.setLineDash([6,4]);
        ctx.lineWidth = 1.2;
        ctx.stroke();
        ctx.fillStyle = 'rgba(255,165,0,0.9)';
        ctx.font = '12px Poppins, Arial';
        ctx.fillText(`Ng∆∞·ª°ng (${warn})`, chart.chartArea.right - 100, yPixel - 6);
        ctx.restore();
      }
    }]
  });

  // populate table
  modalTable.innerHTML = '';
  const arr = (type==='hr'? hourlyData.hr : type==='spo2'? hourlyData.spo2 : type==='bp'? hourlyData.bp : hourlyData.temp);
  for(const r of arr){
    let val = (type==='spo2')? r.value + '%' : (type==='temp'? r.value + '¬∞C' : (type==='bp'? r.value : r.value));
    const st = statusFor(type, r);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.time}</td><td>${val}</td><td class="${st[1]}">${st[0]}</td>`;
    modalTable.appendChild(tr);
  }

  // export
  exportBtn.onclick = ()=>{
    let csv = 'time,value,status\n';
    for(const r of arr){
      const v = (type==='spo2')? r.value + '%' : (type==='temp'? r.value + '¬∞C' : (type==='bp'? r.value : r.value));
      const st = statusFor(type,r)[0];
      csv += `${r.time},${v},${st}\n`;
    }
    const blob = new Blob([csv],{type:'text/csv'}), url = URL.createObjectURL(blob), a=document.createElement('a');
    a.href = url; a.download = `${type}_data.csv`; a.click(); URL.revokeObjectURL(url);
  };
}

closeModal.addEventListener('click', ()=> modalBackdrop.style.display='none');
modalBackdrop.addEventListener('click', (e)=> { if(e.target===modalBackdrop) modalBackdrop.style.display='none'; });

document.querySelectorAll('.card').forEach(card=>{
  card.addEventListener('click', ()=> openModal(card.dataset.type));
});


function connectEra(){
      let configTemp = null, configSPO2 = null, configHB = null, configBP = null;
      const eraWidget = new EraWidget({
        token: "1ced9c99-1cd3-45f6-98a1-82ea28141f85",  // ‚ö†Ô∏è Thay token c·ªßa b·∫°n
        deviceId: "15794"                               // ‚ö†Ô∏è Thay ID thi·∫øt b·ªã c·ªßa b·∫°n
      });
      eraWidget.init({
        needRealtimeConfigs: true,
        needHistoryConfigs: false,
        needActions: false,
        maxRealtimeConfigsCount: 8,
        onConfiguration: (conf) => { 
           configTemp = configuration.realtime_configs[0];
          configHB   = configuration.realtime_configs[1];
          configSPO2 = configuration.realtime_configs[2];
          configBP   = configuration.realtime_configs[3];
          
          console.log('Era configuration', conf); },
        onValues: (values) => {
        const valueTemp = values[configTemp?.id]?.value;
        const valueHB   = values[configHB?.id]?.value;
        const valueSPO2 = values[configSPO2?.id]?.value;
        const valueBP   = values[configBP?.id]?.value;
        if (valueTemp !== undefined) tempEl.innerHTML = `${valueTemp} ¬∞C`;
        if (valueHB !== undefined)   hrEl.innerHTML   = `${valueHB} bpm`;
        if (valueSPO2 !== undefined) spo2El.innerHTML = `${valueSPO2} %`;
        if (valueBP !== undefined)   bpEl.innerHTML   = `${valueBP} mmHg`;
        let eradata1 ={valueBP,valueTemp,valueSPO2,valueHB};
        console.log('Era values:', values);},
        
        })};

/* ---------- UI update helpers ---------- */
function updateHR(v){
  hrEl.innerText = v;
  hrTimeEl.innerText = new Date().toTimeString().slice(0,5);
}
function updateSpO2(v){
  spo2El.innerText = `${v}%`;
  spo2TimeEl.innerText = new Date().toTimeString().slice(0,5);
}
function updateBP(s){
  bpEl.innerText = s;
  bpTimeEl.innerText = new Date().toTimeString().slice(0,5);
}
function updateTemp(t){
  tempEl.innerText = `${t}¬∞C`;
  tempTimeEl.innerText = new Date().toTimeString().slice(0,5);
}

/* ---------- enter dashboard ---------- */
function enterDashboard(){
  applyUserToUI();
  //setOverviewValues();
  showDashboard();
  connectEra();
}

/* ---------- startup: if already logged in show dashboard ---------- */
window.addEventListener('load', ()=>{
  if(getCurrentUser()){ enterDashboard(); } else { showAuth(); }
});

</script>
<script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
</body>
</html>



