<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MS VITA_SYNC - Dashboard m·∫´u</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#7b8b9a;
      --accent:#2fc76b;
      --danger:#ff6b6b;
      --glass: rgba(255,255,255,0.7);
      --radius:14px;
      font-family: 'Inter', system-ui, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: linear-gradient(180deg,#edf2f7 0%, var(--bg) 100%);
      color:#1f2937;
      min-height:100vh;
      padding:24px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:20px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#2fc76b,#12a3f5);
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
    }
    .device-info{
      background:var(--card);
      border-radius:12px;padding:12px 16px;box-shadow:0 6px 18px rgba(20,40,60,.06);
      display:flex;align-items:center;gap:12px;
    }
    .device-info small{display:block;color:var(--muted);font-size:12px}
    .device-info b{display:block;font-size:14px}

    /* Grid of cards */
    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:16px;
      margin-top:14px;
    }
    .card{
      background:var(--card);
      border-radius:16px;
      padding:16px;
      box-shadow: 0 8px 20px rgba(16,40,80,.06);
      cursor:pointer;
      transition:transform .14s ease, box-shadow .14s ease;
      min-height:95px;
      display:flex;flex-direction:column;justify-content:space-between;
    }
    .card:hover{ transform:translateY(-6px); box-shadow:0 18px 34px rgba(16,40,80,.08); }
    .card .title{display:flex;align-items:center;gap:12px;font-weight:600}
    .badge{font-size:12px;color:var(--muted)}
    .value{font-size:28px;font-weight:700}
    .sub{font-size:12px;color:var(--muted)}

    /* layout main */
    .main{
      margin-top:20px;
      display:flex;
      gap:18px;
      align-items:flex-start;
    }
    .left{flex:1}
    .right{width:360px}

    /* Table styles */
    table{width:100%;border-collapse:collapse}
    thead th{ text-align:left;color:var(--muted);font-weight:600;padding:10px 8px;border-bottom:1px solid #edf1f4}
    tbody td{padding:10px 8px;border-bottom:1px solid #f1f5f8}
    .status-normal{color:green;font-weight:600}
    .status-warn{color:orange;font-weight:600}
    .status-danger{color:var(--danger);font-weight:700}

    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(12,20,30,.45);
      display:none;align-items:center;justify-content:center;z-index:50;
    }
    .modal{
      background:var(--card);border-radius:16px;padding:18px;width:92%;max-width:980px;box-shadow:0 30px 60px rgba(10,20,40,.4);
      display:flex;gap:18px;align-items:flex-start;
    }
    .modal .chart-wrap{flex:1}
    .modal .side{width:320px}
    .modal .modal-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
    .close-btn{background:#eee;border-radius:8px;padding:6px 8px;cursor:pointer}

    /* popup settings */
    .settings-form{display:flex;flex-direction:column;gap:10px}
    .settings-form label{font-size:13px;color:var(--muted)}
    .settings-form input{padding:10px;border-radius:10px;border:1px solid #e6eaf0;background:#fbfdff}

    /* footer small nav */
    .nav{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:14px;background:var(--card);padding:8px 20px;border-radius:40px;box-shadow:0 8px 20px rgba(10,20,40,.06);display:flex;gap:12px;align-items:center
    }
    .nav button{background:transparent;border:0;padding:8px 12px;border-radius:30px;cursor:pointer;color:var(--muted)}
    .nav .active{background:#eefaf2;color:var(--accent);font-weight:700}

    /* small screens */
    @media (max-width:860px){
      .main{flex-direction:column}
      .right{width:100%}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">MV</div>
      <div>
        <div style="font-weight:700">MS VITA_SYNC</div>
        <div style="font-size:13px;color:var(--muted)">S·ª©c kh·ªèe th√¥ng minh</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <div class="device-info">
        <div style="min-width:52px">
          <small>Xin ch√†o</small>
          <b id="deviceId">R12M 70F2</b>
        </div>
        <div style="min-width:56px;text-align:right">
          <small>Firmware</small>
          <div style="font-weight:700">2.14</div>
        </div>
      </div>

      <button id="settingsBtn" title="C√†i ƒë·∫∑t" style="padding:10px 12px;border-radius:12px;border:0;background:#fff;box-shadow:0 6px 16px rgba(16,40,80,.04);cursor:pointer">‚öôÔ∏è</button>
      <button id="logoutBtn" title="ƒêƒÉng xu·∫•t" style="padding:10px 12px;border-radius:12px;border:0;background:#fff;box-shadow:0 6px 16px rgba(16,40,80,.04);cursor:pointer">üîì</button>
    </div>
  </div>

  <div class="grid left">
    <div class="card" data-type="hr">
      <div class="title"><div style="font-size:18px">‚ù§Ô∏è Nh·ªãp tim</div><div class="badge">BPM</div></div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="value" id="hrValue">--</div>
          <div class="sub">M·∫∑c ƒë·ªãnh: 60 - 100 BPM</div>
        </div>
        <div style="text-align:right;color:var(--muted);font-size:12px">C·∫≠p nh·∫≠t: <span id="hrTime">--</span></div>
      </div>
    </div>

    <div class="card" data-type="spo2">
      <div class="title"><div style="font-size:18px">üí® SpO‚ÇÇ</div><div class="badge">%</div></div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="value" id="spo2Value">--</div>
          <div class="sub">M·∫∑c ƒë·ªãnh c·∫£nh b√°o: &lt; 94%</div>
        </div>
        <div style="text-align:right;color:var(--muted);font-size:12px">C·∫≠p nh·∫≠t: <span id="spo2Time">--</span></div>
      </div>
    </div>

    <div class="card" data-type="bp">
      <div class="title"><div style="font-size:18px">ü©∏ Huy·∫øt √°p</div><div class="badge">mmHg</div></div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="value" id="bpValue">--</div>
          <div class="sub">H·ªá th·ªëng: 120/80 mmHg chu·∫©n</div>
        </div>
        <div style="text-align:right;color:var(--muted);font-size:12px">C·∫≠p nh·∫≠t: <span id="bpTime">--</span></div>
      </div>
    </div>

    <div class="card" data-type="temp">
      <div class="title"><div style="font-size:18px">üå°Ô∏è Nhi·ªát ƒë·ªô</div><div class="badge">¬∞C</div></div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="value" id="tempValue">--</div>
          <div class="sub">Nhi·ªát ƒë·ªô c∆° th·ªÉ</div>
        </div>
        <div style="text-align:right;color:var(--muted);font-size:12px">C·∫≠p nh·∫≠t: <span id="tempTime">--</span></div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="left" style="flex-basis:65%">
      <div style="background:var(--card);padding:14px;border-radius:14px;box-shadow:0 10px 30px rgba(10,20,40,.04)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">T·ªïng quan s·ª©c kh·ªèe</div>
          <div style="color:var(--muted);font-size:13px">D·ªØ li·ªáu th·ªùi gian th·ª±c</div>
        </div>
        <div id="overviewText" style="color:var(--muted)">Click v√†o m·ªôt ch·ªâ s·ªë ·ªü tr√™n ƒë·ªÉ xem bi·ªÉu ƒë·ªì theo gi·ªù v√† b·∫£ng chi ti·∫øt.</div>
      </div>
    </div>

    <div class="right">
      <div style="background:var(--card);padding:12px;border-radius:14px;box-shadow:0 10px 30px rgba(10,20,40,.04)">
        <div style="font-weight:700;margin-bottom:8px">L·∫ßn ƒëo g·∫ßn ƒë√¢y</div>
        <table>
          <thead>
            <tr><th>Th·ªùi gian</th><th>Ch·ªâ s·ªë</th><th>Gi√° tr·ªã</th></tr>
          </thead>
          <tbody id="recentList">
            <!-- rows -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal (chart + table) -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div style="flex:1;min-width:300px">
        <div class="modal-head">
          <div>
            <div id="modalTitle" style="font-weight:800">Chi ti·∫øt</div>
            <div id="modalSubtitle" style="color:var(--muted);font-size:13px">Bi·ªÉu ƒë·ªì theo gi·ªù</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div id="rangeInfo" style="font-size:13px;color:var(--muted)"></div>
            <div class="close-btn" id="closeModal">‚úñ</div>
          </div>
        </div>
        <div class="chart-wrap">
          <canvas id="lineChart" height="180"></canvas>
        </div>
      </div>

      <div class="side">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:700" id="sideTitle">B·∫£ng s·ªë li·ªáu</div>
          <button id="exportBtn" style="padding:6px 10px;border-radius:8px;border:0;background:#f1f7ff;cursor:pointer">T·∫£i CSV</button>
        </div>

        <div style="height:330px;overflow:auto">
          <table>
            <thead><tr><th>Th·ªùi gian</th><th>Gi√° tr·ªã</th><th>Tr·∫°ng th√°i</th></tr></thead>
            <tbody id="modalTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings popup -->
  <div id="settingsBackdrop" class="modal-backdrop" style="align-items:flex-start;padding-top:60px">
    <div class="modal" style="max-width:560px;flex-direction:column">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><div style="font-weight:800">C√†i ƒë·∫∑t t√†i kho·∫£n</div><div style="color:var(--muted);font-size:13px">Th√¥ng tin c√° nh√¢n & ng∆∞·ª°ng</div></div>
        <div class="close-btn" id="closeSettings">‚úñ</div>
      </div>
      <form id="settingsForm" class="settings-form">
        <label>H·ªç t√™n <input type="text" id="inputName" required></label>
        <label>S·ªë ƒëi·ªán tho·∫°i <input type="tel" id="inputPhone"></label>
        <label>Email <input type="email" id="inputEmail"></label>

        <div style="display:flex;gap:8px">
          <label style="flex:1">Ng∆∞·ª°ng SpO‚ÇÇ (c·∫£nh b√°o n·∫øu <) <input id="thrSpo2" type="number" min="80" max="100"></label>
          <label style="flex:1">Ng∆∞·ª°ng HR cao (>) <input id="thrHrHigh" type="number" min="60" max="200"></label>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
          <button type="button" id="cancelSettings" style="padding:8px 12px;border-radius:10px;border:0;background:#f2f5f8;cursor:pointer">Hu·ª∑</button>
          <button type="submit" style="padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:white;cursor:pointer">L∆∞u</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Logout confirm -->
  <div id="logoutBackdrop" class="modal-backdrop" style="align-items:center;justify-content:center">
    <div class="modal" style="max-width:420px;flex-direction:column">
      <div style="font-weight:800;margin-bottom:8px">X√°c nh·∫≠n ƒëƒÉng xu·∫•t</div>
      <div style="color:var(--muted);margin-bottom:14px">B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t kh·ªèi t√†i kho·∫£n n√†y kh√¥ng?</div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="close-btn" id="cancelLogout">Hu·ª∑</button>
        <button id="confirmLogout" style="padding:8px 12px;border-radius:10px;border:0;background:var(--danger);color:white;cursor:pointer">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
  </div>

  <!-- bottom nav -->
  <div class="nav" aria-hidden="true">
    <button>üè† T·ªïng quan</button>
    <button class="active">üîµ Smart Ring</button>
    <button>‚ûï</button>
    <button>üí¨</button>
    <button>üë§ C√° nh√¢n</button>
  </div>

<script>
/*
  M√¥ t·∫£:
  - D·ªØ li·ªáu m·∫´u hourlyData = { hr:[], spo2:[], bp:[], temp:[] } length 24
  - Click card => m·ªü modal, render chart + table
  - Settings l∆∞u v√†o localStorage
*/

(function(){
  // ---------- sample data generator ----------
  function makeHourlySeries(base,variation,min,max,round=0){
    const arr=[];
    for(let h=0;h<24;h++){
      // smooth random around base, with slight trend
      const trend = Math.sin((h/24)*Math.PI*2)*variation*0.4;
      const noise = (Math.random()*2-1)*variation;
      let v = base + trend + noise;
      v = Math.max(min, Math.min(max, v));
      if(round) v = Math.round(v);
      else v = Math.round(v*10)/10;
      arr.push({time: `${String(h).padStart(2,'0')}:00`, value: v});
    }
    return arr;
  }

  const hourlyData = {
    hr: makeHourlySeries(78,12,45,140,0),
    spo2: makeHourlySeries(97,3,85,100,0),
    bp: [], // we'll store systolic/diastolic as tuple strings
    temp: makeHourlySeries(36.6,0.7,35.5,38.5,1)
  };
  // bp generate
  for(let i=0;i<24;i++){
    const sys=Math.round(115 + Math.sin(i/24*Math.PI*2)*8 + (Math.random()*10-5));
    const dia=Math.round(75 + Math.cos(i/24*Math.PI*2)*6 + (Math.random()*6-3));
    hourlyData.bp.push({time: `${String(i).padStart(2,'0')}:00`, value: `${sys}/${dia}`, sys, dia});
  }

  // initial thresholds (can be changed from settings)
  const thresholds = {
    spo2_warn: 94,
    hr_high: 100
  };

  // fill "current" values from last measurement
  function setOverviewValues(){
    const lastHr = hourlyData.hr[23].value;
    const lastSpo2 = hourlyData.spo2[23].value;
    const lastBp = hourlyData.bp[23].value;
    const lastTemp = hourlyData.temp[23].value;
    document.getElementById('hrValue').innerText = `${lastHr}`;
    document.getElementById('spo2Value').innerText = `${lastSpo2}%`;
    document.getElementById('bpValue').innerText = `${lastBp}`;
    document.getElementById('tempValue').innerText = `${lastTemp}¬∞C`;
    const now = new Date();
    document.getElementById('hrTime').innerText = `${now.getHours()}:00`;
    document.getElementById('spo2Time').innerText = `${now.getHours()}:00`;
    document.getElementById('bpTime').innerText = `${now.getHours()}:00`;
    document.getElementById('tempTime').innerText = `${now.getHours()}:00`;

    // recent list (last 5)
    const recentBody = document.getElementById('recentList');
    recentBody.innerHTML='';
    const types=[ {k:'hr',label:'Nh·ªãp tim',unit:'BPM'}, {k:'spo2',label:'SpO‚ÇÇ','unit':'%'},
                  {k:'bp',label:'Huy·∫øt √°p','unit':'mmHg'}, {k:'temp',label:'Nhi·ªát ƒë·ªô','unit':'¬∞C'} ];
    for(let i=23;i>=19;i--){
      const r = hourlyData.hr[i].value; // choose hr for time label, but alternate rows
      const t = hourlyData.hr[i].time;
      // just as demo add 4 rows mixing types
      types.forEach((tp,idx)=>{
        if(idx>1) return; // keep to 2 first to not be too long
        const val = tp.k==='bp'? hourlyData.bp[i].value : (tp.k==='spo2'? hourlyData.spo2[i].value + (tp.k==='spo2'?'%':''): hourlyData.hr[i].value);
        const row = document.createElement('tr');
        row.innerHTML = `<td>${t}</td><td>${tp.label}</td><td>${val}</td>`;
        recentBody.appendChild(row);
      });
    }
  }

  setOverviewValues();

  // ---------- modal logic ----------
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTable = document.getElementById('modalTable');
  const modalTitle = document.getElementById('modalTitle');
  const modalSubtitle = document.getElementById('modalSubtitle');
  const sideTitle = document.getElementById('sideTitle');
  const rangeInfo = document.getElementById('rangeInfo');
  const exportBtn = document.getElementById('exportBtn');

  let currentChart = null;
  let currentType = null;

  function statusFor(type, valueObj){
    // return {text, class}
    if(type==='spo2'){
      const v = Number(valueObj.value);
      if(v >= thresholds.spo2_warn) return ['B√¨nh th∆∞·ªùng','status-normal'];
      if(v >= thresholds.spo2_warn-4) return ['C·∫£nh b√°o','status-warn'];
      return ['Nguy hi·ªÉm','status-danger'];
    } else if(type==='hr'){
      const v = Number(valueObj.value);
      if(v >= thresholds.hr_high+20) return ['Nguy hi·ªÉm','status-danger'];
      if(v > thresholds.hr_high) return ['C·∫£nh b√°o','status-warn'];
      return ['B√¨nh th∆∞·ªùng','status-normal'];
    } else if(type==='bp'){
      // valueObj has sys,dia
      const sys = valueObj.sys;
      if(sys >= 160) return ['Nguy hi·ªÉm','status-danger'];
      if(sys >= 140) return ['C·∫£nh b√°o','status-warn'];
      return ['B√¨nh th∆∞·ªùng','status-normal'];
    } else if(type==='temp'){
      const v = Number(valueObj.value);
      if(v >= 38) return ['S·ªët','status-warn']; // simplified
      return ['B√¨nh th∆∞·ªùng','status-normal'];
    }
    return ['N/A',''];
  }

  function openModal(type){
    currentType = type;
    modalBackdrop.style.display='flex';
    // title
    const mapTitle = {hr:'Nh·ªãp tim (BPM)', spo2:'SpO‚ÇÇ (%)', bp:'Huy·∫øt √°p (mmHg)', temp:'Nhi·ªát ƒë·ªô (¬∞C)'};
    modalTitle.innerText = mapTitle[type] || 'Chi ti·∫øt';
    modalSubtitle.innerText = 'Bi·ªÉu ƒë·ªì theo gi·ªù trong ng√†y';
    sideTitle.innerText = 'Danh s√°ch c√°c l·∫ßn ƒëo';

    // prepare labels + dataset
    let labels = [];
    let data = [];
    let warnLine = null;
    let highLine = null;

    if(type==='hr'){
      labels = hourlyData.hr.map(d=>d.time);
      data = hourlyData.hr.map(d=>d.value);
      warnLine = thresholds.hr_high;
    } else if(type==='spo2'){
      labels = hourlyData.spo2.map(d=>d.time);
      data = hourlyData.spo2.map(d=>d.value);
      warnLine = thresholds.spo2_warn;
    } else if(type==='bp'){
      labels = hourlyData.bp.map(d=>d.time);
      data = hourlyData.bp.map(d=>d.sys); // show systolic for chart
      // Add diastolic as secondary dataset visually? keep single dataset for simplicity
      warnLine = 140; // hypertension threshold
    } else if(type==='temp'){
      labels = hourlyData.temp.map(d=>d.time);
      data = hourlyData.temp.map(d=>d.value);
      warnLine = 37.5;
    }

    rangeInfo.innerText = `Ng∆∞·ª°ng: ${warnLine || '‚Äî'}`;

    // render chart (destroy old)
    if(currentChart) { currentChart.destroy(); currentChart = null; }

    const ctx = document.getElementById('lineChart').getContext('2d');
    const datasets = [{
      label: mapTitle[type],
      data: data,
      tension:0.3,
      fill:true,
      pointRadius:3
    }];
    // create chart with plugin for horizontal line
    currentChart = new Chart(ctx, {
      type:'line',
      data:{labels, datasets},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          y:{
            beginAtZero:false,
            grid:{color:'#eef2f6'}
          },
          x:{grid:{display:false}}
        },
        plugins:{
          legend:{display:false},
          annotation: {
            // placeholder - not using chartjs-annotation plugin, will draw using afterDraw
          }
        },
        animation:{duration:300}
      },
      plugins: [{
        // plugin to draw horizontal threshold line
        id: 'thresholdLine',
        afterDraw(chart){
          const yValue = warnLine;
          if(!yValue) return;
          const yScale = chart.scales.y;
          const ctx = chart.ctx;
          const yPixel = yScale.getPixelForValue(yValue);
          ctx.save();
          ctx.beginPath();
          ctx.moveTo(chart.chartArea.left, yPixel);
          ctx.lineTo(chart.chartArea.right, yPixel);
          ctx.strokeStyle = 'rgba(255,165,0,0.9)';
          ctx.lineWidth = 1.5;
          ctx.setLineDash([6,4]);
          ctx.stroke();
          ctx.fillStyle = 'rgba(255,165,0,0.9)';
          ctx.font = '12px Inter, Arial';
          ctx.fillText(`Ng∆∞·ª°ng (${yValue})`, chart.chartArea.right - 90, yPixel - 6);
          ctx.restore();
        }
      }]
    });

    // populate table
    modalTable.innerHTML='';
    let arr = hourlyData[type];
    for(let i=0;i<arr.length;i++){
      const r = arr[i];
      let val = '';
      let status = ['', ''];
      if(type==='bp'){
        val = r.value;
        status = statusFor(type, r);
      } else {
        val = (type==='spo2')? r.value + '%' : (type==='temp'? r.value + '¬∞C' : r.value);
        status = statusFor(type, r);
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.time}</td><td>${val}</td><td class="${status[1]}">${status[0]}</td>`;
      modalTable.appendChild(tr);
    }

    // export handler
    exportBtn.onclick = ()=> {
      let csv = 'time,value,status\n';
      for(const r of arr){
        let value = (type==='bp')? r.value : r.value;
        const st = statusFor(type, r)[0];
        csv += `${r.time},${value},${st}\n`;
      }
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${type}_data.csv`; a.click();
      URL.revokeObjectURL(url);
    };
  }

  // close modal
  document.getElementById('closeModal').addEventListener('click',()=>{ modalBackdrop.style.display='none'; });

  // attach click on cards
  document.querySelectorAll('.card').forEach(card=>{
    card.addEventListener('click', ()=>{
      const type = card.dataset.type;
      openModal(type);
    });
  });

  // settings logic
  const settingsBackdrop = document.getElementById('settingsBackdrop');
  document.getElementById('settingsBtn').addEventListener('click', ()=> {
    settingsBackdrop.style.display='flex';
    // load from localStorage
    const store = JSON.parse(localStorage.getItem('mv_settings') || '{}');
    document.getElementById('inputName').value = store.name || 'Nguy·ªÖn VƒÉn A';
    document.getElementById('inputPhone').value = store.phone || '0983xxxxxx';
    document.getElementById('inputEmail').value = store.email || '';
    document.getElementById('thrSpo2').value = store.thrSpo2 || thresholds.spo2_warn;
    document.getElementById('thrHrHigh').value = store.thrHrHigh || thresholds.hr_high;
  });
  document.getElementById('closeSettings').addEventListener('click', ()=> settingsBackdrop.style.display='none');
  document.getElementById('cancelSettings').addEventListener('click', ()=> settingsBackdrop.style.display='none');
  document.getElementById('settingsForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const store = {
      name: document.getElementById('inputName').value,
      phone: document.getElementById('inputPhone').value,
      email: document.getElementById('inputEmail').value,
      thrSpo2: Number(document.getElementById('thrSpo2').value) || thresholds.spo2_warn,
      thrHrHigh: Number(document.getElementById('thrHrHigh').value) || thresholds.hr_high
    };
    // save and apply thresholds
    thresholds.spo2_warn = store.thrSpo2;
    thresholds.hr_high = store.thrHrHigh;
    localStorage.setItem('mv_settings', JSON.stringify(store));
    settingsBackdrop.style.display='none';
    alert('ƒê√£ l∆∞u c√†i ƒë·∫∑t');
  });

  // logout logic
  const logoutBackdrop = document.getElementById('logoutBackdrop');
  document.getElementById('logoutBtn').addEventListener('click', ()=> logoutBackdrop.style.display='flex');
  document.getElementById('cancelLogout').addEventListener('click', ()=> logoutBackdrop.style.display='none');
  document.getElementById('confirmLogout').addEventListener('click', ()=> {
    logoutBackdrop.style.display='none';
    alert('B·∫°n ƒë√£ ƒëƒÉng xu·∫•t (m√¥ ph·ªèng).');
    // here you'd redirect to login
  });

  // init: hide modals
  modalBackdrop.style.display='none';
  settingsBackdrop.style.display='none';
  logoutBackdrop.style.display='none';

  // small UX: clicking backdrop closes settings/logout but not modal content
  [settingsBackdrop, logoutBackdrop].forEach(b => {
    b.addEventListener('click', (e)=> { if(e.target===b) b.style.display='none'; });
  });
  // modal backdrop close by clicking outside
  modalBackdrop.addEventListener('click', (e)=> { if(e.target===modalBackdrop) modalBackdrop.style.display='none'; });

  // initial filling
  setOverviewValues();

})();
else status = '<span class="status-normal">B√¨nh th∆∞·ªùng</span>';
      return `<tr><td>${t}</td><td>${val}</td><td>${status}</td></tr>`;
    }).join("");
  }

  currentChart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets },
    options: {
      responsive: true,
      plugins: { legend: { position: "top" } },
      scales: { y: { beginAtZero: false } }
    }
  });
}


    function closeChart() { document.getElementById("chartPopup").style.display = "none"; }

    function openSettings() {
      const popup = document.getElementById("settingPopup");
      const info = document.getElementById("userInfo");
      if (!currentUser) return;
      info.innerHTML = `
        <p><b>H·ªç t√™n:</b> ${currentUser.name}</p>
        <p><b>Tu·ªïi:</b> ${currentUser.age}</p>
        <p><b>Gi·ªõi t√≠nh:</b> ${currentUser.gender}</p>
        <p><b>C√¢n n·∫∑ng:</b> ${currentUser.weight} kg</p>
        <p><b>Chi·ªÅu cao:</b> ${currentUser.height} cm</p>
        <p><b>B·ªánh l√Ω:</b> ${currentUser.history}</p>
        <p><b>ƒê·ªô c·∫≠n:</b> ${currentUser.eyes}</p>`;
      popup.style.display = "flex";
    }

    function closeSettings() { document.getElementById("settingPopup").style.display = "none"; }
    function logout() {
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("loginBox").style.display = "block";
      document.getElementById("settingPopup").style.display = "none";
      currentUser = null;
    }
      const temp = document.getElementById('temp');
      const spo2 = document.getElementById('spo2');
      const hb   = document.getElementById('heart');
      const bp   = document.getElementById('bp');

      let configTemp = null, configSPO2 = null, configHB = null, configBP = null;

      const eraWidget = new EraWidget({
        token: "1ced9c99-1cd3-45f6-98a1-82ea28141f85",  // ‚ö†Ô∏è Thay token c·ªßa b·∫°n
        deviceId: "15794"                               // ‚ö†Ô∏è Thay ID thi·∫øt b·ªã c·ªßa b·∫°n
      });

      eraWidget.init({
        needRealtimeConfigs: true,
        needHistoryConfigs: true,
        needActions: false,
        maxRealtimeConfigsCount: 4,
        maxHistoryConfigsCount: 1,

        onConfiguration: (configuration) => {
          configTemp = configuration.realtime_configs[0];
          configHB   = configuration.realtime_configs[1];
          configSPO2 = configuration.realtime_configs[2];
          configBP   = configuration.realtime_configs[3];
          configbutall  = configuration.realtime_configs[4];
          configbutHB=configuration.realtime_configs[5];
          configbutspo2=configuration.realtime_configs[6];
          configbutBP=configuration.realtime_configs[7];
          configbutTEMP=configuration.realtime_configs[8];
          console.log('Configuration:', configuration);
        },

        onValues: (values) => {
          const valueTemp = values[configTemp?.id]?.value;
const valueHB   = values[configHB?.id]?.value;
          const valueSPO2 = values[configSPO2?.id]?.value;
          const valueBP   = values[configBP?.id]?.value;

          if (valueTemp !== undefined) temp.innerHTML = `${valueTemp} ¬∞C`;
          if (valueHB !== undefined)   hb.innerHTML   = `${valueHB} bpm`;
          if (valueSPO2 !== undefined) spo2.innerHTML = `${valueSPO2} %`;
          if (valueBP !== undefined)   bp.innerHTML   = `${valueBP} mmHg`;

          console.log("Values:", values);
        }
      });
</script>
<script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
</body>
</html>
